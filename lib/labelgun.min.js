!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("rbush")):"function"==typeof define&&define.amd?define(["rbush"],t):"object"==typeof exports?exports.labelgun=t(require("rbush")):e.labelgun=t(e.rbush)}(this,function(e){return function(e){function t(a){if(i[a])return i[a].exports;var n=i[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var i={};return t.m=e,t.c=i,t.i=function(e){return e},t.d=function(e,i,a){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:a})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=1)}([function(t,i){t.exports=e},function(e,t,i){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}function n(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),s=i(0),l=a(s),h=function(){function e(t,i){r(this,e),this.tree=(0,l.default)(6),this.allLabels={},this._point=void 0,this.hasChanged=new Set,this.loaded=!1,this.hasZoomed=!1,this.hideLabel=t,this.showLabel=i}return o(e,[{key:"destroy",value:function(){this.resetTree(),this.allLabels={}}},{key:"forceLabelStates",value:function(e,t){this._labelHasChangedStates(e,t)}},{key:"_labelHasChangedStates",value:function(e,t){var i=this;this.tree.all().forEach(function(a){i._labelHasChangedState(a,e,t)})}},{key:"_labelHasChangedState",value:function(e,t,i){var a=i||e.state;"show"===a&&this.showLabel(e),"hide"===a&&this.hideLabel(e)}},{key:"setupLabelStates",value:function(){var e=this;if(this.hasZoomed){this.hasZoomed=!1,this.hasChanged.clear(),this.resetTree();for(var t in this.allLabels){var i=this.allLabels[t];this._prioritiseLabel({bottomLeft:[i.minX,i.minY],topRight:[i.maxX,i.maxY]},i.id,i.weight,i.labelObject,i.name,i.isDragged)}}else if(this.hasChanged.size){var a=[].concat(n(this.hasChanged));this.hasChanged.clear(),a.forEach(function(t){var i=e.allLabels[t];e._prioritiseLabel({bottomLeft:[i.minX,i.minY],topRight:[i.maxX,i.maxY]},i._id,i.weight,i.labelObject,i.name,i.isDragged)})}}},{key:"update",value:function(){this.hasZoomed=!0,this.handleExCollisions(),this.forceLabelStates(!0),this.resetTree()}},{key:"handleExCollisions",value:function(){var e=this;this.tree.all().forEach(function(t){e._handleExCollisions(t)})}},{key:"resetTree",value:function(){this.tree.clear()}},{key:"_makeLabel",value:function(e,t,i,a,n,r){return{minX:e.bottomLeft[0],minY:e.bottomLeft[1],maxX:e.topRight[0],maxY:e.topRight[1],state:"hide",id:t,weight:i||1,labelObject:a,labelName:n,isDragged:r}}},{key:"removeFromTree",value:function(e,t){var i=e.id||e,a=this.allLabels[i];this.tree.remove(a),delete this.allLabels[i],t&&this._labelHasChangedStates(!0)}},{key:"_addToTree",value:function(e){this.allLabels[e.id]=e,this.tree.insert(e)}},{key:"_handleCollisions",value:function(e,t,i){var a=void 0;t.isDragged&&(t.weight=1/0);var n=t;e.forEach(function(e){var i=e.id!==t.id;i&&(e.isDragged&&(a=e.weight,n=e,n.weight=1/0),e.weight>n.weight?(n.state="hide",n=e):e.state="hide")}),n.state="show",a&&(n.weight=a)}},{key:"_throttle",value:function(e,t){var i=!1;return function(){i||(e.call(),i=!0,setTimeout(function(){i=!1},t))}}},{key:"_throttledHandleCollisions",value:function(e,t,i,a){return this._throttle(function(){this._handleCollisions(e,t,i)}.bind(this),a)()}},{key:"_handleExCollisions",value:function(e){if("hide"===e.state){for(var t=!1,i=this.tree.search(e),a=0;a<i.length;a++)if("hide"!==i[a].state){t=!0;break}t||(e.state="show")}}},{key:"_throttledHandleExCollisions",value:function(e){return this._throttle(function(){var e=this;this.tree.all().forEach(function(t){e._handleExCollisions(t)})}.bind(this),e)()}},{key:"prioritiseLabel",value:function(e,t,i,a,n,r){var o=this._makeLabel(e,t,i,a,n,r),s=!this.allLabels[t];s||this.removeFromTree(o),this._addToTree(o);var l=this.tree.search(o);return!l.length||r?void(o.state="show"):void this._throttledHandleCollisions(l,o,r,1e3)}},{key:"labelHasChanged",value:function(e){this.hasChanged.add(e)}}]),e}();t.default=h}])});