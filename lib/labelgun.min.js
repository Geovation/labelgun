!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("rbush")):"function"==typeof define&&define.amd?define(["rbush"],t):"object"==typeof exports?exports.labelgun=t(require("rbush")):e.labelgun=t(e.rbush)}(this,function(e){return function(e){function t(a){if(i[a])return i[a].exports;var o=i[a]={exports:{},id:a,loaded:!1};return e[a].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){"use strict";function a(e){return e&&e.__esModule?e:{"default":e}}function o(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),s=i(1),l=a(s),h=function(){function e(){var t=this;n(this,e),this.tree=(0,l["default"])(6),this._overlay=void 0,this.allLabels={},this._point=void 0,this.hasChanged=new Set,this.loaded=!1,this.hasZoomed=!1;var i=this;Podaris.SolverController.queueFinish("labellingEngine",function(){t.loaded=!0,i._setupLabelStates(),i._updateLabelStates()})}return r(e,[{key:"destroy",value:function(){this.resetTree(),this.allLabels={},this._overlay&&this._overlay.setMap(null)}},{key:"forceLabelStates",value:function(e,t){this._updateLabelStates(e,t)}},{key:"_updateLabelStates",value:function(e,t){this.tree.all().forEach(function(i){this._updateLabelState(i,e,t)}.bind(this))}},{key:"_updateLabelState",value:function(e,t,i){var a=e.gmLabel,o=i||e.state;a.get("labelClass").indexOf(o)===-1&&a.set("labelClass","markerLabels "+o),t&&Podaris.SolverController.queueLazyRender(e.id)}},{key:"_setupLabelStates",value:function(){if(this.hasZoomed)this.hasZoomed=!1,this.hasChanged.clear(),this.resetTree(),Podaris.Station.find().forEach(function(e){e.boundingBox&&this._prioritiseLabel(e.boundingBox,e._id,e.weight,e.label,e.name,e.isDragged)}.bind(this));else if(this.hasChanged.size){var e=[].concat(o(this.hasChanged));this.hasChanged.clear(),e.forEach(function(e){var t=Podaris.Station.findOne(e);t.boundingBox&&this._prioritiseLabel(t.boundingBox,t._id,t.weight,t.label,t.name,t.isDragged)}.bind(this))}this._throttledHandleExCollisions(1e3)}},{key:"resetTree",value:function(){this.tree.clear(),this._resetOverlay()}},{key:"_resetOverlay",value:function(){var e=new google.maps.OverlayView;e.draw=function(){},e.setMap(Podaris.map),this._overlay=e}},{key:"_getOverlay",value:function(){return this._overlay||this._resetOverlay(),this._overlay}},{key:"_getPoint",value:function(e,t){return this._point||(this._point=new google.maps.Point(0,0)),this._point.x=e,this._point.y=t,this._point}},{key:"_project",value:function(e,t){return this._getOverlay().getProjection().fromDivPixelToLatLng(this._getPoint(e,t))}},{key:"_makeLabel",value:function(e,t,i,a,o,n){return{minX:e.bottomLeft.lng(),minY:e.bottomLeft.lat(),maxX:e.topRight.lng(),maxY:e.topRight.lat(),state:"fade-out",id:t,weight:i,gmLabel:a,labelName:o,isDragged:n}}},{key:"removeFromTree",value:function(e,t){var i=e.id||e,a=this.allLabels[i];this.tree.remove(a),delete this.allLabels[i],t&&this._updateLabelStates(!0)}},{key:"_addToTree",value:function(e){this.allLabels[e.id]=e,this.tree.insert(e)}},{key:"_handleCollisions",value:function(e,t,i){var a=void 0;t.isDragged&&(t.weight=1/0);var o=t;e.forEach(function(e){var i=e.id!==t.id;i&&(e.isDragged&&(a=e.weight,o=e,o.weight=1/0),e.weight>o.weight?(o.state="fade-out",o=e):e.state="fade-out")},this),o.state="fade-in",a&&(o.weight=a)}},{key:"_throttledHandleCollisions",value:function(e,t,i,a){return _.throttle(function(){this._handleCollisions(e,t,i)}.bind(this),a)()}},{key:"_handleExCollisions",value:function(e){if("fade-out"===e.state){for(var t=!1,i=this.tree.search(e),a=0;a<i.length;a++)if("fade-out"!==i[a].state){t=!0;break}t||(e.state="fade-in")}}},{key:"_throttledHandleExCollisions",value:function(e){return _.throttle(function(){this.tree.all().forEach(this._handleExCollisions,this)}.bind(this),e)()}},{key:"_prioritiseLabel",value:function(e,t,i,a,o,n){var r=this._makeLabel(e,t,i,a,o,n),s=!this.allLabels[t];s||this.removeFromTree(r),this._addToTree(r);var l=this.tree.search(r);return!l.length||n?void(r.state="fade-in"):void this._throttledHandleCollisions(l,r,n,1e3)}},{key:"_labelAnchor",value:function(e,t,i,a,o){a=a||Podaris.Entities.renderVars;var n=o||a.stationLabelSize,r=12+Podaris.getTextWidth(e||"",n+"px sans-serif"),s=.5*r,l=t+a.m2px*i+n+5;return{position:new google.maps.Point(s,l),height:l,width:r}}},{key:"_labelStyle",value:function(e,t,i){return{color:e,"background-color":t,"font-size":i+"px","text-shadow":"1px 1px 0 "+t+", -1px -1px 0 "+t+", 1px -1px 0 "+t+", -1px 1px 0 "+t}}},{key:"_calculateBoundingBox",value:function(e,t){var i=this.getScreenPosition(t);return{bottomLeft:this._project(e.position.x-e.width+i.x,e.position.y-e.height+i.y),topRight:this._project(e.position.x+i.x,e.position.y-2*e.height+i.y)}}},{key:"getScreenPosition",value:function(e){return this._getOverlay().getProjection().fromLatLngToContainerPixel(e)}},{key:"styleLabel",value:function(e,t,i,a,o,n,r,s,l){var h,u="rgba(0,0,0,0.5)",d="rgba(0,0,0,1)",f="rgba(255,255,255,0.5)",c="rgba(255,255,255,1)",g=function(e){return[255-e.r,255-e.g,255-e.b]};"layer"===s.stationLabelColor?h=tinycolor(i).isLight()?u:f:(i=s.stationLabelColor,h="white"===i?u:f);var b=s.stationLabelSize;if(e.isDragged){var v=tinycolor(i);i=0===v.getBrightness()?c:225===v.getBrightness()?d:"rgba("+g(tinycolor(i).toRgb()).join(",")+",1)",h=tinycolor(i).isLight()?d:c}var p=this._labelStyle(i,h,b),y=this._labelAnchor(e.name,n,r,s,b),_=this._calculateBoundingBox(y,o);e.boundingBox=_,t.labelAnchor=y.position,t.labelContent=e.name||"",t.zIndex=e.isDragged?999:a+2,t.labelStyle=p,t.position=o,e.label.setOptions(t),e.weight=l,this.hasChanged.add(e._id)}}]),e}();t["default"]=h},function(t,i){t.exports=e}])});