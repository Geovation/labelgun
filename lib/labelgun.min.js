!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("rbush")):"function"==typeof define&&define.amd?define(["rbush"],t):"object"==typeof exports?exports.labelgun=t(require("rbush")):e.labelgun=t(e.rbush)}(this,function(e){return function(e){function t(i){if(a[i])return a[i].exports;var n=a[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var a={};return t.m=e,t.c=a,t.i=function(e){return e},t.d=function(e,a,i){t.o(e,a)||Object.defineProperty(e,a,{configurable:!1,enumerable:!0,get:i})},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=1)}([function(t,a){t.exports=e},function(e,t,a){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,a,i){return a&&e(t.prototype,a),i&&e(t,i),t}}(),r=a(0),o=i(r),h=function(){function e(t,a){l(this,e),this.tree=(0,o.default)(6),this.allLabels={},this._point=void 0,this.hasChanged=new Set,this.loaded=!1,this.allChanged=!1,this.hideLabel=t,this.showLabel=a}return s(e,[{key:"_total",value:function(e){var t=0;for(var a in this.allLabels)this.allLabels[a].state==e&&(t+=1);return t}},{key:"totalShown",value:function(){return this._total("show")}},{key:"totalHidden",value:function(){return this._total("hide")}},{key:"_getLabelsByState",value:function(e){var t=[];for(var a in this.allLabels)this.allLabels[a].state==e&&t.push(this.allLabels[a]);return t}},{key:"getHidden",value:function(){return this._getLabelsByState("hide")}},{key:"getShown",value:function(){return this._getLabelsByState("show")}},{key:"getCollisions",value:function(e){var t=this.allLabels[e],a=this.tree.search(t),i=a.indexOf(t);return void 0!==i&&a.splice(i,1),a}},{key:"getLabel",value:function(e){return this.allLabels[e]}},{key:"destroy",value:function(){this._resetTree(),this.allLabels={}}},{key:"forceLabelStates",value:function(e){var t=this;this.tree.all().forEach(function(a){t._labelHasChangedState(a,e)})}},{key:"_labelHasChangedState",value:function(e,t){var a=t||e.state;"show"===a&&this.showLabel(e),"hide"===a&&this.hideLabel(e)}},{key:"setupLabelStates",value:function(){var e=this;if(this.allChanged){this.allChanged=!1,this.hasChanged.clear(),this._resetTree();for(var t in this.allLabels){var a=this.allLabels[t];this.ingestLabel({bottomLeft:[a.minX,a.minY],topRight:[a.maxX,a.maxY]},a.id,a.weight,a.labelObject,a.name,a.isDragged)}}else if(this.hasChanged.size){var i=[].concat(n(this.hasChanged));this.hasChanged.clear(),i.forEach(function(t){var a=e.allLabels[t];e.ingestLabel({bottomLeft:[a.minX,a.minY],topRight:[a.maxX,a.maxY]},a._id,a.weight,a.labelObject,a.name,a.isDragged)})}}},{key:"update",value:function(){this.allChanged=!0,this.setupLabelStates(),this.handleExCollisions(),this._hideShownCollisions(),this.forceLabelStates()}},{key:"handleExCollisions",value:function(){var e=this;this.getHidden().forEach(function(t){e._handleExCollisions(t)})}},{key:"_resetTree",value:function(){this.tree.clear()}},{key:"_makeLabel",value:function(e,t,a,i,n,l){return{minX:e.bottomLeft[0],minY:e.bottomLeft[1],maxX:e.topRight[0],maxY:e.topRight[1],state:"hide",id:t,weight:a||1,labelObject:i,labelName:n,isDragged:l}}},{key:"removeFromTree",value:function(e,t){var a=e.id||e,i=this.allLabels[a];this.tree.remove(i),delete this.allLabels[a],t&&this.forceLabelStates(!0)}},{key:"_addToTree",value:function(e){this.allLabels[e.id]=e,this.tree.insert(e)}},{key:"_hideShownCollisions",value:function(){var e=this;this.getShown().forEach(function(t){e.getCollisions(t.id).forEach(function(e){"show"==e.state&&(e.state="hide")})})}},{key:"_handleCollisions",value:function(e,t,a){var i=void 0;t.isDragged&&(t.weight=1/0);var n=t;e.forEach(function(e){e.isDragged&&(i=e.weight,n=e,n.weight=1/0),e.weight>n.weight?(n.state="hide",n=e):e.state="hide"}),n.state="show",i&&(n.weight=i)}},{key:"_handleExCollisions",value:function(e){if("hide"===e.state){for(var t=!1,a=this.tree.search(e),i=0;i<a.length;i++)if("hide"!==a[i].state){t=!0;break}t||(e.state="show")}}},{key:"ingestLabel",value:function(e,t,a,i,n,l){var s=this._makeLabel(e,t,a,i,n,l),r=this.allLabels[t];r&&this.removeFromTree(r),this._addToTree(s);var o=this.getCollisions(t);return!o.length||l?void(s.state="show"):void this._handleCollisions(o,s,l)}},{key:"labelHasChanged",value:function(e){this.hasChanged.add(e)}}]),e}();t.default=h}])});