<!-- <doctype html> -->
<html>
  <head>
    <style>
      html, body, #map {
        width: 100%;
        height: 100%;
        padding: 0px;
        margin: 0px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
    <script src="../../../node_modules/systemjs/dist/system.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script>

      console.log("Leaflet Demo");

      // Confiure location of necessary modules
      SystemJS.config({
        map : {
          rbush : "/../../node_modules/rbush/rbush.js",
          labelgun : "/../../lib/labelgun.js"
        }
      });

      SystemJS.import('fetch');
      SystemJS.import('labelgun').then(function(labelgun) {


        // Leaflet map
        var map = L.map('map').setView([0, 0], 6);
        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Labelgun!
        var hideLabel = function(label){label.labelObject.style.display = "none";};
        var showLabel = function(label){label.labelObject.style.display = "block";};
        var labelEngine = new labelgun.default(hideLabel, showLabel);

        console.log(fetch);
        var id = 0;
        fetch("../geojson/cupcakes.geojson")
          .then(function(response){ return response.json()})
          .then(function(geojson){
            var markers = L.geoJSON(geojson, {
              onEachFeature : function(feature, layer) {

                layer.bindTooltip("Test", {permanent: true}).openTooltip();
                layer.on("add", function(){

                  id++
                  var label = layer.getTooltip()._source._tooltip._container;
                  console.log(label);
                  var rect = label.getBoundingClientRect();

                  var bottomLeft = [rect.left, rect.bottom];
                  var topRight = [rect.right, rect.top];
                  bottomLeft = map.containerPointToLatLng(bottomLeft);
                  topRight = map.containerPointToLatLng(topRight);

                  var boundingBox = {
                      bottomLeft : [bottomLeft.lng, bottomLeft.lat],
                      topRight   : [topRight.lng, topRight.lat]
                  };

                  labelEngine._prioritiseLabel(
                    boundingBox,
                    id,
                    Math.random() * (5 - 1) + 1, // Weight
                    label,
                    "Test " + id,
                    false
                  )
                })
                layer.addTo(map);
                labelEngine.labelHasChanged(id);

              }
            }).addTo(map)

            map.fitBounds(markers.getBounds());

            console.log("ALL ADDED");
            labelEngine.forceLabelStates(true);


          });

      });

    </script>
  </body>
</html>
